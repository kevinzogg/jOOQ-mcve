package org.jooq.mcve.repository;

import org.jooq.mcve.model.Product;
import org.jooq.mcve.model.TranslationMap;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.boot.test.autoconfigure.jooq.AutoConfigureJooq;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Map;

@SpringBootTest(classes = { ProductRepositoryTest.PersistenceConfiguration.class },
				properties = { "spring.liquibase.changeLog: classpath:db/changelog/db.changelog-master.xml" })
public class ProductRepositoryTest {

	@Autowired
	private ProductRepository productRepository;

	@Test
	@Disabled("Issue #10951 -> https://github.com/jOOQ/jOOQ/issues/10951")
	@Transactional
	public void findActiveProducts() {
		Map<String, String> translations = Map.of("de", "Produkt Eins", "en", "Product One");
		Product testproduct = new Product("product.one", TranslationMap.of(translations));
		productRepository.persistProduct(testproduct);

		// Issue #10951 happens here
		List<Product> products = productRepository.findActiveProducts();

		Assertions.assertEquals(1, products.size());
	}

	@Configuration
	@EntityScan(basePackages = { "org.jooq.mcve.model" })
	@ComponentScan(basePackages = { "org.jooq.mcve.repository" })
	@AutoConfigureJooq
	public static class PersistenceConfiguration {
	}

}
